name: Deploy Subdomain Server (Final)

on:
  push:
    branches: [main]
    paths:
      - 'subdomain-server.js'
      - '.github/workflows/subdomain-server-final.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-2

      - name: Deploy to EC2
        run: |
          echo "ğŸš€ ì„œë¸Œë„ë©”ì¸ ì„œë²„ ë°°í¬ ì‹œì‘..."
          
          # S3ì— íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp subdomain-server.js s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy/
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > deploy.sh << 'DEPLOY'
          #!/bin/bash
          set -e
          cd /home/ec2-user
          
          # íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy/subdomain-server.js ./
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          pkill -f subdomain-server || true
          sleep 2
          
          # Node.js ì„¤ì¹˜ í™•ì¸
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # ì„œë²„ ì‹œì‘
          nohup node subdomain-server.js > /var/log/subdomain.log 2>&1 &
          
          # í…ŒìŠ¤íŠ¸
          sleep 5
          curl -f http://localhost:3001 && echo "âœ… ì„œë²„ ì‹œì‘ ì„±ê³µ" || echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
          DEPLOY
          
          # S3ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ
          aws s3 cp deploy.sh s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy.sh
          
          # ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ID: $INSTANCE_ID"
          
          # ê°„ë‹¨í•œ User Dataë¡œ ë°°í¬ ì‹¤í–‰
          USER_DATA='#!/bin/bash
          cd /home/ec2-user
          aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy.sh ./
          chmod +x github-deploy.sh
          ./github-deploy.sh > /var/log/github-deploy.log 2>&1'
          
          # ì¸ìŠ¤í„´ìŠ¤ ì¬ì‹œì‘
          aws ec2 stop-instances --instance-ids $INSTANCE_ID
          aws ec2 wait instance-stopped --instance-ids $INSTANCE_ID
          
          # User Data ì„¤ì • (base64 ì¸ì½”ë”©)
          echo "$USER_DATA" | base64 | tr -d '\n' > user-data-b64.txt
          aws ec2 modify-instance-attribute --instance-id $INSTANCE_ID --user-data file://user-data-b64.txt
          
          # ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘
          aws ec2 start-instances --instance-ids $INSTANCE_ID
          aws ec2 wait instance-running --instance-ids $INSTANCE_ID
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: Update DNS and Health Check
        run: |
          # ìƒˆ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          NEW_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].PublicIpAddress' \
            --output text)
          
          echo "ğŸŒ ìƒˆ IP: $NEW_IP"
          
          # DNS ì—…ë°ì´íŠ¸
          aws route53 change-resource-record-sets \
            --hosted-zone-id Z0193893QRN4IUT309BL \
            --change-batch '{
              "Changes": [{
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "*.pagecube.net",
                  "Type": "A",
                  "TTL": 300,
                  "ResourceRecords": [{"Value": "'$NEW_IP'"}]
                }
              }]
            }'
          
          echo "âœ… DNS ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          
          # í—¬ìŠ¤ì²´í¬
          echo "â³ 2ë¶„ ëŒ€ê¸° í›„ í—¬ìŠ¤ì²´í¬..."
          sleep 120
          
          for i in {1..5}; do
            if curl -f --connect-timeout 10 http://$NEW_IP:3001; then
              echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë²„ ì‹¤í–‰ ì¤‘: http://$NEW_IP:3001"
              echo "ğŸ”— í…ŒìŠ¤íŠ¸: curl -H 'Host: 4asd.pagecube.net' http://$NEW_IP:3001"
              exit 0
            fi
            echo "â³ ì¬ì‹œë„ ì¤‘... ($i/5)"
            sleep 15
          done
          
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
