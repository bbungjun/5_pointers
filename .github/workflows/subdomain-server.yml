name: Deploy Subdomain Server to AWS EC2

on:
  push:
    branches: [main]
    paths:
      - 'subdomain-server.js'
      - 'subdomain-proxy.js'
      - '.github/workflows/subdomain-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-2

      - name: Upload files and create deployment script
        run: |
          echo "ğŸ“¤ Uploading files to S3..."

          # S3ì— ì„œë²„ íŒŒì¼ë“¤ ì—…ë¡œë“œ
          aws s3 cp subdomain-server.js s3://elasticbeanstalk-ap-northeast-2-490004614784/deploy/
          aws s3 cp subdomain-proxy.js s3://elasticbeanstalk-ap-northeast-2-490004614784/deploy/

          # Ubuntuìš© ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > ubuntu-deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸš€ Ubuntu deployment started at $(date)" | tee -a /var/log/deploy.log

          # Ubuntu ì‚¬ìš©ì í™ˆìœ¼ë¡œ ì´ë™
          cd /home/ubuntu

          # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
          echo "ğŸ“¦ Updating system..." | tee -a /var/log/deploy.log
          apt-get update -y

          # Node.js 20 ì„¤ì¹˜
          echo "ğŸ“¦ Installing Node.js 20..." | tee -a /var/log/deploy.log
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

          echo "âœ… Node.js installed: $(node -v)" | tee -a /var/log/deploy.log

          # AWS CLI ì„¤ì¹˜ (í•„ìš”ì‹œ)
          if ! command -v aws &> /dev/null; then
            echo "ğŸ“¦ Installing AWS CLI..." | tee -a /var/log/deploy.log
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            ./aws/install
          fi

          # íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¥ Downloading server files..." | tee -a /var/log/deploy.log
          aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/deploy/subdomain-server.js ./ --region ap-northeast-2
          aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/deploy/subdomain-proxy.js ./ --region ap-northeast-2

          # ì†Œìœ ê¶Œ ë³€ê²½
          chown ubuntu:ubuntu *.js

          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "ğŸ”„ Stopping existing processes..." | tee -a /var/log/deploy.log
          pkill -f subdomain-server || true
          pkill -f "node.*subdomain" || true
          sleep 3

          # package.json ìƒì„±
          cat > package.json << 'PKG'
          {
            "name": "pagecube-subdomain-server",
            "version": "1.0.0",
            "main": "subdomain-server.js",
            "dependencies": {
              "express": "^4.18.2",
              "axios": "^1.6.0",
              "cors": "^2.8.5",
              "mysql2": "^3.6.0"
            }
          }
          PKG

          chown ubuntu:ubuntu package.json

          # ì˜ì¡´ì„± ì„¤ì¹˜ (ubuntu ì‚¬ìš©ìë¡œ)
          echo "ğŸ“¦ Installing dependencies..." | tee -a /var/log/deploy.log
          sudo -u ubuntu npm install --production

          # deployed-sites ë””ë ‰í† ë¦¬ ìƒì„±
          sudo -u ubuntu mkdir -p deployed-sites

          # ì„œë²„ ì‹œì‘ (ubuntu ì‚¬ìš©ìë¡œ)
          echo "ğŸš€ Starting server..." | tee -a /var/log/deploy.log
          sudo -u ubuntu nohup node subdomain-server.js > /var/log/subdomain-server.log 2>&1 &

          echo "âœ… Server started with PID: $!" | tee -a /var/log/deploy.log
          sleep 10

          # ì„œë²„ í…ŒìŠ¤íŠ¸
          if curl -f http://localhost:3001 >/dev/null 2>&1; then
            echo "âœ… Server is responding on port 3001" | tee -a /var/log/deploy.log
            echo "ğŸ‰ Deployment completed successfully at $(date)" | tee -a /var/log/deploy.log
          else
            echo "âŒ Server is not responding" | tee -a /var/log/deploy.log
            echo "ğŸ“‹ Process check:" | tee -a /var/log/deploy.log
            ps aux | grep node | tee -a /var/log/deploy.log
            echo "ğŸ“‹ Port check:" | tee -a /var/log/deploy.log
            netstat -tlnp | grep 3001 | tee -a /var/log/deploy.log
            exit 1
          fi
          SCRIPT

          # S3ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì—…ë¡œë“œ
          aws s3 cp ubuntu-deploy.sh s3://elasticbeanstalk-ap-northeast-2-490004614784/ubuntu-deploy.sh

          echo "âœ… Files uploaded to S3"

      - name: Deploy to EC2 instance
        run: |
          # ì¸ìŠ¤í„´ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
          INSTANCE_ID=$(aws ec2 describe-instances \
            --region ap-northeast-2 \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)

          if [ -z "$INSTANCE_ID" ]; then
            echo "âŒ Instance not found"
            exit 1
          fi

          echo "âœ… Found instance: $INSTANCE_ID"

          # ê°„ë‹¨í•œ User Data ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > user-data.sh << 'USERDATA'
          #!/bin/bash
          exec > /var/log/user-data.log 2>&1
          set -e

          echo "Starting user data execution at $(date)"

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰
          cd /tmp
          aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/ubuntu-deploy.sh ./ --region ap-northeast-2
          chmod +x ubuntu-deploy.sh
          ./ubuntu-deploy.sh

          echo "User data execution completed at $(date)"
          USERDATA

          echo "ğŸ”„ Restarting instance with deployment script..."

          # ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
          aws ec2 stop-instances --instance-ids $INSTANCE_ID --region ap-northeast-2
          aws ec2 wait instance-stopped --instance-ids $INSTANCE_ID --region ap-northeast-2

          # User Data ì„¤ì • (íŒŒì¼ ë°©ì‹)
          aws ec2 modify-instance-attribute \
            --instance-id $INSTANCE_ID \
            --user-data file://user-data.sh \
            --region ap-northeast-2

          # ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘
          aws ec2 start-instances --instance-ids $INSTANCE_ID --region ap-northeast-2
          aws ec2 wait instance-running --instance-ids $INSTANCE_ID --region ap-northeast-2

          echo "âœ… Instance restarted successfully"

      - name: Update DNS and Health Check
        run: |
          # ìƒˆ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          NEW_IP=$(aws ec2 describe-instances \
            --region ap-northeast-2 \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].PublicIpAddress' \
            --output text)

          echo "ğŸŒ New IP address: $NEW_IP"

          # DNS ì—…ë°ì´íŠ¸
          echo "ğŸ”„ Updating DNS..."
          aws route53 change-resource-record-sets \
            --hosted-zone-id Z0193893QRN4IUT309BL \
            --change-batch '{
              "Changes": [{
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "*.pagecube.net",
                  "Type": "A",
                  "TTL": 300,
                  "ResourceRecords": [{"Value": "'$NEW_IP'"}]
                }
              }]
            }' > /dev/null

          echo "âœ… DNS updated: *.pagecube.net â†’ $NEW_IP"

          # í—¬ìŠ¤ì²´í¬ (3ë¶„ ëŒ€ê¸° - User Data ì‹¤í–‰ ì‹œê°„ ê³ ë ¤)
          echo "â³ Waiting 3 minutes for deployment to complete..."
          sleep 180

          # í—¬ìŠ¤ì²´í¬ ì‹œë„
          echo "ğŸ” Performing health checks..."
          for i in {1..15}; do
            echo "ğŸ” Health check attempt $i/15..."

            if curl -f --connect-timeout 10 --max-time 30 http://$NEW_IP:3001 >/dev/null 2>&1; then
              echo "âœ… Health check passed!"

              # ì„œë¸Œë„ë©”ì¸ í…ŒìŠ¤íŠ¸
              echo "ğŸ” Testing subdomain..."
              if curl -H "Host: 4asd.pagecube.net" --connect-timeout 10 http://$NEW_IP:3001 >/dev/null 2>&1; then
                echo "âœ… Subdomain test passed!"
              else
                echo "âš ï¸ Subdomain test failed, but server is running"
              fi

              echo ""
              echo "ğŸ‰ Deployment completed successfully!"
              echo "ğŸŒ Subdomain server is running: http://$NEW_IP:3001"
              echo "ğŸ”— Test subdomain: curl -H 'Host: 4asd.pagecube.net' http://$NEW_IP:3001"
              echo "ğŸŒ Live test: https://4asd.pagecube.net"
              exit 0
            fi

            echo "â³ Attempt $i failed, retrying in 20 seconds..."
            sleep 20
          done

          echo "âŒ Health check failed after 15 attempts"
          echo "ğŸ“‹ Server may still be starting. Check manually:"
          echo "ğŸ“‹ Server URL: http://$NEW_IP:3001"
          echo "ğŸ“‹ Subdomain URL: https://4asd.pagecube.net"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ubuntu-deploy.sh user-data.sh
